{% extends "layout.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>1. 动态参数</h1>
    <button class="btn btn-primary" onclick="toggleAddForm()">+ 新增汇率</button>
</div>

<div id="addForm" class="card" style="display: none; margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem;">新增汇率记录</h3>
    <form action="/daily/add" method="post"
        style="display: grid; grid-template-columns: repeat(3, 1fr) auto; gap: 1rem; align-items: end;">
        <div>
            <label style="display: block; font-size: 0.8rem; margin-bottom: 0.3rem;">币种</label>
            <select name="currency_code" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                <option value="1">USD (美元)</option>
                <option value="2">KRW (韩元)</option>
                <option value="3">JPY (日元)</option>
                <option value="4">EUR (欧元)</option>
            </select>
        </div>
        <div>
            <label style="display: block; font-size: 0.8rem; margin-bottom: 0.3rem;">汇率</label>
            <input type="number" step="0.0001" name="exchange_rate" placeholder="1.0000" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
        </div>
        <div></div>
        <button type="submit" class="btn btn-primary">提交保存</button>
    </form>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>序号(ID)</th>
                <th>记录日期</th>
                <th>币种 (1:USD 2:KRW 3:JPY 4:EUR)</th>
                <th>汇率 (双击修改)</th>
                <th>创建时间</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.id }}</td>
                <td>{{ item.record_date }}</td>
                <td>
                    {% if item.currency_code == 1 %}USD{% elif item.currency_code == 2 %}KRW{% elif item.currency_code
                    == 3 %}JPY{% elif item.currency_code == 4 %}EUR{% else %}{{ item.currency_code }}{% endif %}
                </td>
                <td ondblclick="makeEditable(this, {{ item.id }})">{{ item.exchange_rate }}</td>
                <td>{{ item.created_at }}</td>
            </tr>
            {% endfor %}
            {% if not items %}
            <tr>
                <td colspan="5" style="text-align: center; color: var(--secondary);">暂无数据</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
    function toggleAddForm() {
        const form = document.getElementById('addForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function makeEditable(td, id) {
        if (td.querySelector('input')) return;
        const originalValue = td.innerText;
        td.innerHTML = `<input type="number" step="0.0001" value="${originalValue}" style="width: 100px; padding: 4px;">`;
        const input = td.querySelector('input');
        input.focus();

        input.onblur = function () {
            const newValue = input.value;
            if (newValue === originalValue) {
                td.innerText = originalValue;
                return;
            }

            const formData = new FormData();
            formData.append('id', id);
            formData.append('exchange_rate', newValue);

            fetch('/api/daily/update', {
                method: 'POST',
                body: formData
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    td.innerText = newValue;
                    // Add a small green flash for feedback
                    td.style.backgroundColor = '#dcfce7';
                    setTimeout(() => td.style.backgroundColor = 'transparent', 1000);
                } else {
                    alert('更新失败: ' + data.message);
                    td.innerText = originalValue;
                }
            });
        };

        input.onkeydown = function (e) {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') { td.innerText = originalValue; }
        };
    }
</script>
{% endblock %}